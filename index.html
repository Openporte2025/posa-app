<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ”§ Posa App v1.66 - OpenPorte</title>
    
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           POSA APP v1.66 - TOKEN PERSONALI & LOGIN SICURO
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* RESET & BASE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
            line-height: 1.6;
        }
        
        /* LOGIN SCREEN */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            padding: 1rem;
        }
        
        .login-box {
            background: white;
            border-radius: 16px;
            padding: 2.5rem;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        
        .login-logo {
            text-align: center;
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        
        .login-title {
            text-align: center;
            font-size: 1.75rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }
        
        .login-subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 2rem;
        }
        
        .login-field {
            margin-bottom: 1.5rem;
        }
        
        .login-field label {
            display: block;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 0.5rem;
        }
        
        .login-field input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .login-field input:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.15);
        }
        
        .login-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        .login-btn:active {
            transform: translateY(0);
        }
        
        .login-help {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
            font-size: 0.875rem;
            color: #718096;
        }
        
        .login-help a {
            color: #d97706;
            text-decoration: none;
            font-weight: 600;
        }
        
        .login-error {
            background: #fed7d7;
            color: #c53030;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }
        
        /* LOGOUT BUTTON */
        .logout-btn {
            background: rgba(239, 68, 68, 0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.4);
        }
        
        /* MAIN APP (hidden until login) */
        .main-app {
            display: none;
        }
        
        .main-app.active {
            display: block;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MOBILE-FIRST SMARTPHONE OPTIMIZATION
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* BANNER INFO CLIENTE */
        .cliente-banner {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 1rem;
        }
        
        .cliente-nome {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .cliente-contatti {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .cliente-campo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255,255,255,0.15);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cliente-campo:hover, .cliente-campo:active {
            background: rgba(255,255,255,0.25);
        }
        
        .campo-icon {
            font-size: 1.2rem;
        }
        
        .campo-valore {
            flex: 1;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .campo-copia {
            opacity: 0.7;
            font-size: 0.9rem;
        }
        
        /* RIEPILOGO QUANTITÃ€ */
        .riepilogo-qty {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        
        .qty-badge {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            background: rgba(255,255,255,0.2);
            padding: 0.4rem 0.75rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .qty-badge .qty-num {
            background: white;
            color: #1e3a5f;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-weight: 700;
        }
        
        /* HEADER COMPATTO MOBILE */
        .header-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .header-actions button {
            padding: 0.5rem 0.75rem;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* TOAST NOTIFICA COPIA */
        .toast-copia {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: toastIn 0.3s ease;
        }
        
        @keyframes toastIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        /* TOUCH OPTIMIZATION iPad */
        button, a, label, [onclick] {
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            cursor: pointer;
            min-height: 44px;
            min-width: 44px;
        }
        
        input, select, textarea {
            font-size: 16px !important; /* Prevent iOS zoom */
        }
        
        html {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        
        /* HEADER COMPATTO */
        .posa-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            font-size: 1rem;
            font-weight: 700;
        }
            align-items: center;
            gap: 0.5rem;
        }
        
        .project-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        #project-name {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .header-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .sync-status {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .sync-status.syncing {
            animation: spin 1s linear infinite;
        }
        
        .sync-status.saved {
            background: rgba(34, 197, 94, 0.3);
        }
        
        .sync-status.error {
            background: rgba(239, 68, 68, 0.3);
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* NAVIGAZIONE VISTE */
        .posa-nav {
            display: flex;
            gap: 1rem;
            padding: 1rem 2rem;
            background: white;
            border-bottom: 2px solid #e2e8f0;
            overflow-x: auto;
        }
        
        .posa-nav button {
            padding: 0.75rem 1.5rem;
            border: none;
            background: #e2e8f0;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .posa-nav button:hover {
            background: #cbd5e1;
        }
        
        .posa-nav button.active {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }
        
        .indicator {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-left: 0.25rem;
        }
        
        /* CONTENUTO PRINCIPALE */
        #posa-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #64748b;
        }
        
        .empty-state h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #475569;
        }
        
        .empty-state p {
            font-size: 1rem;
            margin-bottom: 2rem;
        }
        
        .empty-state button {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .empty-state button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .posa-header {
                padding: 1rem;
                flex-wrap: wrap;
            }
            
            .logo {
                font-size: 1.2rem;
            }
            
            .posa-nav {
                padding: 0.75rem 1rem;
            }
            
            .posa-nav button {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            
            #posa-content {
                padding: 1rem;
            }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           VISTA PER POSIZIONE - CARD GRID
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .posizioni-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }
        
        .posizione-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .posizione-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .posizione-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .posizione-id {
            font-size: 1.25rem;
            font-weight: 700;
            color: #f59e0b;
        }
        
        .posizione-completamento {
            font-size: 0.9rem;
            font-weight: 700;
        }
        
        .posizione-info {
            margin-bottom: 0.75rem;
        }
        
        .posizione-location {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }
        
        .posizione-ambiente {
            font-size: 0.85rem;
            color: #718096;
        }
        
        .posizione-misure {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: #f7fafc;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #4a5568;
        }
        
        .prodotti-list {
            margin: 1rem 0;
        }
        
        .prodotto-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f7fafc;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .prodotto-icon {
            font-size: 1.1rem;
        }
        
        .prodotto-label {
            flex: 1;
            color: #4a5568;
            font-weight: 500;
        }
        
        .prodotto-qty {
            font-weight: 700;
            color: #f59e0b;
        }
        
        .prodotto-item-empty {
            color: #94a3b8;
            font-size: 0.85rem;
            font-style: italic;
            padding: 0.5rem;
            text-align: center;
        }
        
        .posizione-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #f1f5f9;
        }
        
        .posizione-total {
            font-size: 0.85rem;
            color: #718096;
        }
        
        .posizione-action {
            font-size: 0.85rem;
            color: #f59e0b;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .posizioni-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           VISTA PER PRODOTTO - SEZIONI RAGGRUPPATE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .prodotti-sections {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .prodotto-section {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .prodotto-section-header {
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .prodotto-section-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .prodotto-section-icon {
            font-size: 1.5rem;
        }
        
        .prodotto-section-label {
            font-size: 1.25rem;
            font-weight: 700;
            color: #2d3748;
        }
        
        .prodotto-section-count {
            font-size: 0.9rem;
            color: #718096;
        }
        
        .prodotto-section-count strong {
            color: #2d3748;
            font-weight: 700;
        }
        
        .prodotto-section-content {
            padding: 0 1.5rem 1.5rem 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        
        .prodotto-posizione-item {
            background: #f7fafc;
            padding: 1rem;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .prodotto-posizione-item:hover {
            background: #e2e8f0;
            transform: translateX(4px);
        }
        
        .prodotto-posizione-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .prodotto-posizione-id {
            font-weight: 700;
            color: #2d3748;
        }
        
        .prodotto-posizione-qty {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .prodotto-posizione-location {
            font-size: 0.85rem;
            color: #4a5568;
            margin-bottom: 0.25rem;
        }
        
        .prodotto-posizione-misure {
            font-size: 0.8rem;
            color: #718096;
            margin-bottom: 0.25rem;
        }
        
        .prodotto-posizione-azienda {
            font-size: 0.8rem;
            color: #718096;
        }
        
        @media (max-width: 768px) {
            .prodotto-section-content {
                grid-template-columns: 1fr;
            }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           VISTA PER AZIENDA - RAGGRUPPAMENTO FORNITORI
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .aziende-sections {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .azienda-section {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .azienda-section-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .azienda-section-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .azienda-section-icon {
            font-size: 1.5rem;
        }
        
        .azienda-section-label {
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .azienda-section-count {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .azienda-section-count strong {
            font-weight: 700;
        }
        
        .azienda-section-content {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .azienda-prodotto-gruppo {
            background: #f7fafc;
            padding: 1rem;
            border-radius: 8px;
        }
        
        .azienda-prodotto-tipo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .azienda-prodotto-tipo-qty {
            color: #6366f1;
            font-size: 1.1rem;
        }
        
        .azienda-prodotto-lista {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .azienda-prodotto-item {
            background: white;
            padding: 0.75rem;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .azienda-prodotto-item:hover {
            background: #eef2ff;
            transform: translateX(4px);
        }
        
        .azienda-prodotto-posizione {
            font-weight: 700;
            color: #4f46e5;
            min-width: 60px;
        }
        
        .azienda-prodotto-details {
            flex: 1;
        }
        
        .azienda-prodotto-location {
            font-size: 0.85rem;
            color: #4a5568;
            margin-bottom: 0.25rem;
        }
        
        .azienda-prodotto-misure {
            font-size: 0.8rem;
            color: #718096;
        }
        
        .azienda-prodotto-qty {
            font-weight: 700;
            color: #6366f1;
            font-size: 1.1rem;
        }
        
        @media (max-width: 768px) {
            .azienda-section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- SCHERMATA LOGIN -->
    <div id="login-screen" class="login-screen">
        <div class="login-box">
            <div class="login-logo">ğŸ”§</div>
            <h1 class="login-title">Posa App</h1>
            <p class="login-subtitle">Accedi con il tuo token GitHub personale</p>
            
            <div id="login-error" class="login-error"></div>
            
            <div class="login-field">
                <label for="github-token">Token GitHub</label>
                <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxx" autocomplete="off">
            </div>
            
            <button class="login-btn" onclick="doLogin()">
                ğŸ” Accedi
            </button>
            
            <div class="login-help">
                <strong>Come ottenere il token:</strong><br>
                1. Vai su <a href="https://github.com/settings/tokens" target="_blank">GitHub â†’ Settings â†’ Tokens</a><br>
                2. Crea "Personal access token (classic)"<br>
                3. Seleziona permesso <code>repo</code><br>
                4. Copia e incolla qui sopra
            </div>
        </div>
    </div>

    <!-- MAIN APP (nascosta fino a login) -->
    <div id="main-app" class="main-app">
    
    <!-- HEADER COMPATTO -->
    <header class="posa-header">
        <div class="logo">ğŸ”§ v1.66</div>
        <div class="header-actions">
            <button class="header-btn" onclick="caricaProgetto()">ğŸ“‚</button>
            <button id="sync-btn" class="sync-status" onclick="syncManuale()">âŸ³</button>
            <button class="logout-btn" onclick="doLogout()">ğŸšª</button>
        </div>
    </header>
    
    <!-- BANNER INFO CLIENTE (visibile solo con progetto caricato) -->
    <div id="cliente-banner" class="cliente-banner" style="display: none;">
        <div class="cliente-nome" id="cliente-nome-display">-</div>
        <div class="cliente-contatti">
            <div class="cliente-campo" onclick="copiaClipboard('cliente-indirizzo')">
                <span class="campo-icon">ğŸ“</span>
                <span class="campo-valore" id="cliente-indirizzo">-</span>
                <span class="campo-copia">ğŸ“‹</span>
            </div>
            <div class="cliente-campo" onclick="copiaClipboard('cliente-telefono')">
                <span class="campo-icon">ğŸ“</span>
                <span class="campo-valore" id="cliente-telefono">-</span>
                <span class="campo-copia">ğŸ“‹</span>
            </div>
        </div>
        <!-- RIEPILOGO QUANTITÃ€ -->
        <div class="riepilogo-qty" id="riepilogo-qty"></div>
    </div>
    
    <!-- NAVIGAZIONE VISTE -->
    <nav class="posa-nav">
        <button class="active" onclick="switchView('posizione')">
            ğŸ“ Posizione
            <span class="indicator" id="indicator-posizione"></span>
        </button>
        <button onclick="switchView('prodotto')">
            ğŸªŸ Prodotto
            <span class="indicator" id="indicator-prodotto"></span>
        </button>
        <button onclick="switchView('azienda')">
            ğŸ¢ Azienda
            <span class="indicator" id="indicator-azienda"></span>
        </button>
    </nav>
    
    <!-- CONTENUTO PRINCIPALE -->
    <main id="posa-content">
        <div class="empty-state">
            <h2>ğŸ“‚ Nessun progetto caricato</h2>
            <p>Carica un progetto da GitHub per iniziare</p>
            <button onclick="caricaProgetto()">
                ğŸ“¡ Carica da GitHub
            </button>
        </div>
    </main>
    
    </div><!-- Fine main-app -->
    
    <script>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           POSA APP v1.66 - TOKEN PERSONALI & LOGIN SICURO
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        // VARIABILI GLOBALI
        let currentProject = null;
        let currentView = 'posizione';
        let hasUnsavedChanges = false;
        
        // CONFIGURAZIONE GITHUB (token da localStorage)
        const GITHUB_CONFIG = {
            owner: 'Openporte2025',
            repo: 'dati-cantieri',
            branch: 'main',
            get token() {
                return localStorage.getItem('posa_app_github_token') || '';
            }
        };
        
        /**
         * LOGIN - Verifica token e mostra app
         */
        async function doLogin() {
            const tokenInput = document.getElementById('github-token');
            const errorDiv = document.getElementById('login-error');
            const token = tokenInput.value.trim();
            
            if (!token) {
                errorDiv.textContent = 'âš ï¸ Inserisci il token GitHub';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                errorDiv.textContent = 'âš ï¸ Token non valido. Deve iniziare con ghp_ o github_pat_';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Test token con API GitHub
            errorDiv.style.display = 'none';
            tokenInput.disabled = true;
            
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Token non valido o scaduto');
                }
                
                const user = await response.json();
                console.log('âœ… Login riuscito:', user.login);
                
                // Salva token e mostra app
                localStorage.setItem('posa_app_github_token', token);
                showApp();
                
            } catch (error) {
                errorDiv.textContent = 'âŒ ' + error.message;
                errorDiv.style.display = 'block';
                tokenInput.disabled = false;
            }
        }
        
        /**
         * LOGOUT - Rimuove token e torna a login
         */
        function doLogout() {
            if (hasUnsavedChanges) {
                if (!confirm('Hai modifiche non salvate. Vuoi davvero uscire?')) {
                    return;
                }
            }
            
            localStorage.removeItem('posa_app_github_token');
            localStorage.removeItem('posa_app_current_project');
            
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-app').classList.remove('active');
            document.getElementById('github-token').value = '';
            
            console.log('ğŸšª Logout effettuato');
        }
        
        /**
         * Mostra app principale
         */
        function showApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').classList.add('active');
            init();
        }
        
        /**
         * Check login all'avvio
         */
        document.addEventListener('DOMContentLoaded', function() {
            const savedToken = localStorage.getItem('posa_app_github_token');
            
            if (savedToken) {
                // Token salvato, verifica e mostra app
                console.log('ğŸ”‘ Token trovato, verifico...');
                showApp();
            } else {
                // Nessun token, mostra login
                document.getElementById('login-screen').style.display = 'flex';
            }
            
            // Enter key per login
            document.getElementById('github-token').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') doLogin();
            });
        });
        
        /**
         * Inizializzazione app (chiamata dopo login)
         */
        function init() {
            console.log('ğŸ”§ Posa App v1.66 - Inizializzazione...');
            
            // Setup navigazione
            setupNavigation();
            
            // Verifica se c'Ã¨ un progetto salvato
            const savedProject = localStorage.getItem('posa_app_current_project');
            if (savedProject) {
                try {
                    currentProject = JSON.parse(savedProject);
                    const projectName = currentProject.name || currentProject.client || 'Progetto';
                    console.log('âœ… Progetto ripristinato:', projectName);
                    
                    // Aggiorna banner cliente
                    aggiornaBannerCliente();
                    aggiornaRiepilogoQty();
                    
                    // Renderizza vista corrente
                    switchView(currentView);
                } catch (e) {
                    console.error('âŒ Errore ripristino progetto:', e);
                }
            }
            
            // Verifica se c'Ã¨ un ID progetto da caricare (passato da dashboard)
            const projectId = localStorage.getItem('posa_app_project_id');
            if (projectId && !savedProject) {
                console.log('ğŸ“‚ ID progetto trovato da dashboard:', projectId);
                mostraSelezioneProgetto();
            }
            
            console.log('âœ… Posa App inizializzata');
        }
        
        /**
         * Setup navigazione tra viste
         */
        function setupNavigation() {
            // Gestione pulsanti navigazione
            document.querySelectorAll('.posa-nav button').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Rimuovi active da tutti
                    document.querySelectorAll('.posa-nav button').forEach(b => b.classList.remove('active'));
                    // Aggiungi active a questo
                    this.classList.add('active');
                });
            });
        }
        
        /**
         * Switch tra viste
         */
        function switchView(view) {
            currentView = view;
            console.log('ğŸ”„ Switch vista:', view);
            
            // Reset selezione azienda quando si cambia vista
            aziendaSelezionata = null;
            
            if (!currentProject) {
                mostraEmptyState();
                return;
            }
            
            // Renderizza vista appropriata
            switch(view) {
                case 'posizione':
                    mostraVistaPerPosizione();
                    break;
                case 'prodotto':
                    mostraVistaPerProdotto();
                    break;
                case 'azienda':
                    mostraVistaPerAzienda();
                    break;
            }
            
            // Aggiorna indicatori menu
            aggiornaIndicatoriMenu();
        }
        
        /**
         * Mostra empty state
         */
        function mostraEmptyState() {
            const content = document.getElementById('posa-content');
            content.innerHTML = `
                <div class="empty-state">
                    <h2>ğŸ“‚ Nessun progetto caricato</h2>
                    <p>Carica un progetto da GitHub per iniziare</p>
                    <button onclick="caricaProgetto()">
                        ğŸ“¡ Carica da GitHub
                    </button>
                </div>
            `;
        }
        
        /**
         * Carica progetto (placeholder per Step 2)
         */
        function caricaProgetto() {
            // Mostra modal per selezione progetto
            mostraSelezioneProgetto();
        }
        
        /**
         * Mostra modal selezione progetto
         */
        async function mostraSelezioneProgetto() {
            try {
                console.log('ğŸ“¡ Caricamento lista progetti da GitHub...');
                
                // Aggiorna indicatore sync
                const syncBtn = document.getElementById('sync-btn');
                syncBtn.textContent = 'âŸ³ Caricamento...';
                syncBtn.classList.add('syncing');
                
                // Carica lista progetti
                const progetti = await loadProjectsListFromGitHub();
                
                if (progetti.length === 0) {
                    alert('âŒ Nessun progetto trovato su GitHub');
                    syncBtn.textContent = 'âŸ³ Sync';
                    syncBtn.classList.remove('syncing');
                    return;
                }
                
                // Crea modal con lista progetti
                const modal = document.createElement('div');
                modal.id = 'projects-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const projectsList = progetti.map((p, i) => `
                    <div onclick="selezionaProgetto('${p.path}')" 
                         style="padding: 1rem; background: #f7fafc; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s;"
                         onmouseover="this.style.background='#e2e8f0'"
                         onmouseout="this.style.background='#f7fafc'">
                        <div style="font-weight: 600; color: #2d3748; margin-bottom: 0.25rem; font-size: 1.1rem;">
                            ğŸ‘¤ ${p.customerName || 'Cliente N/D'}
                        </div>
                        <div style="font-size: 0.9rem; color: #4a5568; margin-bottom: 0.25rem;">
                            ğŸ“ ${p.indirizzo || 'Indirizzo N/D'}
                        </div>
                        <div style="font-size: 0.8rem; color: #718096; display: flex; justify-content: space-between;">
                            <span>ğŸ“‚ ${p.name}</span>
                            <span>ğŸ“¦ ${p.numPosizioni || '?'} posizioni</span>
                        </div>
                    </div>
                `).join('');
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 70vh; overflow-y: auto;">
                        <h2 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.5rem;">
                            ğŸ“‚ Seleziona Progetto
                        </h2>
                        <p style="color: #718096; margin-bottom: 1.5rem;">
                            Trovati ${progetti.length} progetti su GitHub
                        </p>
                        <div id="projects-list">
                            ${projectsList}
                        </div>
                        <div style="margin-top: 1.5rem; text-align: right;">
                            <button onclick="chiudiModalProgetti()" 
                                    style="padding: 0.75rem 1.5rem; background: #e2e8f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #4a5568;">
                                Annulla
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                syncBtn.textContent = 'âœ… Lista caricata';
                syncBtn.classList.remove('syncing');
                syncBtn.classList.add('saved');
                
                setTimeout(() => {
                    syncBtn.textContent = 'âŸ³ Sync';
                    syncBtn.classList.remove('saved');
                }, 2000);
                
            } catch (error) {
                console.error('âŒ Errore caricamento progetti:', error);
                alert('âŒ Errore: ' + error.message);
                
                const syncBtn = document.getElementById('sync-btn');
                syncBtn.textContent = 'âŒ Errore';
                syncBtn.classList.remove('syncing');
                syncBtn.classList.add('error');
                
                setTimeout(() => {
                    syncBtn.textContent = 'âŸ³ Sync';
                    syncBtn.classList.remove('error');
                }, 3000);
            }
        }
        
        /**
         * Carica lista progetti da GitHub CON DETTAGLI CLIENTE
         */
        async function loadProjectsListFromGitHub() {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/git/trees/${GITHUB_CONFIG.branch}?recursive=1`;
            
            const headers = {
                'Accept': 'application/vnd.github.v3+json'
            };
            
            if (GITHUB_CONFIG.token) {
                headers['Authorization'] = `token ${GITHUB_CONFIG.token}`;
            }
            
            const response = await fetch(url, { headers });
            
            if (!response.ok) {
                throw new Error(`GitHub API error: ${response.status}`);
            }
            
            const tree = await response.json();
            
            // Filtra file JSON progetto
            const projectFiles = tree.tree
                .filter(f => 
                    f.path.endsWith('.json') && 
                    f.type === 'blob' &&
                    f.path.includes('progetto-')
                )
                .map(f => ({
                    name: f.path.split('/').pop(),
                    path: f.path,
                    sha: f.sha
                }));
            
            console.log(`ğŸ“‚ Trovati ${projectFiles.length} progetti, carico dettagli...`);
            
            // Carica dettagli cliente per ogni progetto (in parallelo)
            const projectsWithDetails = await Promise.all(
                projectFiles.map(async (p) => {
                    try {
                        const detailUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${p.path}?ref=${GITHUB_CONFIG.branch}`;
                        const detailResponse = await fetch(detailUrl, { headers });
                        
                        if (detailResponse.ok) {
                            const fileData = await detailResponse.json();
                            const content = JSON.parse(atob(fileData.content));
                            
                            // Estrai nome cliente (prova vari campi)
                            const nomeCliente = content.name || content.client || content.customerName || content.cliente || '';
                            
                            // Estrai indirizzo/cittÃ 
                            let indirizzo = '';
                            if (content.clientData) {
                                const cd = content.clientData;
                                indirizzo = [cd.indirizzo, cd.citta, cd.cap].filter(x => x).join(', ');
                            }
                            if (!indirizzo) {
                                indirizzo = content.indirizzo || content.address || content.citta || '';
                            }
                            
                            return {
                                ...p,
                                customerName: nomeCliente,
                                indirizzo: indirizzo,
                                numPosizioni: (content.posizioni || content.positions || []).length,
                                linkSchizzo: content.linkSchizzo || ''
                            };
                        }
                    } catch (e) {
                        console.warn('âš ï¸ Errore caricamento dettagli:', p.name, e);
                    }
                    return p;
                })
            );
            
            console.log(`âœ… Dettagli caricati per ${projectsWithDetails.length} progetti`);
            return projectsWithDetails;
        }
        
        /**
         * Seleziona e carica progetto
         */
        async function selezionaProgetto(projectPath) {
            try {
                console.log('ğŸ“¥ Caricamento progetto:', projectPath);
                
                // Chiudi modal
                chiudiModalProgetti();
                
                // Aggiorna indicatore sync
                const syncBtn = document.getElementById('sync-btn');
                syncBtn.textContent = 'âŸ³ Caricamento...';
                syncBtn.classList.add('syncing');
                
                // Carica dati progetto
                const projectData = await loadProjectFromGitHub(projectPath);
                
                if (!projectData) {
                    throw new Error('Dati progetto non validi');
                }
                
                // Salva progetto corrente
                currentProject = projectData;
                localStorage.setItem('posa_app_current_project', JSON.stringify(projectData));
                localStorage.setItem('posa_app_project_path', projectPath);
                
                // Aggiorna Banner Cliente
                aggiornaBannerCliente();
                aggiornaRiepilogoQty();
                
                const projectName = projectData.name || projectData.client || 'Progetto';
                console.log('âœ… Progetto caricato:', projectName);
                
                syncBtn.textContent = 'âœ…';
                syncBtn.classList.remove('syncing');
                syncBtn.classList.add('saved');
                
                setTimeout(() => {
                    syncBtn.textContent = 'âŸ³';
                    syncBtn.classList.remove('saved');
                }, 2000);
                
                // Renderizza vista corrente
                switchView(currentView);
                
                // Aggiorna indicatori menu
                aggiornaIndicatoriMenu();
                
            } catch (error) {
                console.error('âŒ Errore caricamento progetto:', error);
                alert('âŒ Errore: ' + error.message);
                
                const syncBtn = document.getElementById('sync-btn');
                syncBtn.textContent = 'âŒ Errore';
                syncBtn.classList.remove('syncing');
                syncBtn.classList.add('error');
            }
        }
        
        /**
         * Carica dati progetto da GitHub
         */
        async function loadProjectFromGitHub(projectPath) {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${projectPath}?ref=${GITHUB_CONFIG.branch}`;
            
            const headers = {
                'Accept': 'application/vnd.github.v3+json'
            };
            
            if (GITHUB_CONFIG.token) {
                headers['Authorization'] = `token ${GITHUB_CONFIG.token}`;
            }
            
            const response = await fetch(url, { headers });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            // L'API GitHub restituisce il contenuto in base64
            const content = atob(data.content.replace(/\n/g, ''));
            const projectData = JSON.parse(content);
            
            // NORMALIZZA: positions (inglese) -> posizioni (italiano)
            if (!projectData.posizioni && projectData.positions) {
                projectData.posizioni = projectData.positions;
                console.log('ğŸ“‹ Normalizzato: positions â†’ posizioni (' + projectData.positions.length + ')');
            }
            
            // NORMALIZZA: qta -> quantita per tutti i prodotti
            const tipiProdotto = ['infisso', 'persiana', 'tapparella', 'zanzariera', 'cassonetto', 'portaInterna', 'ingresso'];
            if (projectData.posizioni) {
                projectData.posizioni.forEach(pos => {
                    tipiProdotto.forEach(tipo => {
                        if (pos[tipo]) {
                            // Converti qta -> quantita
                            if (pos[tipo].qta !== undefined && pos[tipo].quantita === undefined) {
                                pos[tipo].quantita = parseInt(pos[tipo].qta) || 0;
                            }
                            // Se non c'Ã¨ quantita, imposta default 1 se ha dati significativi
                            if (pos[tipo].quantita === undefined) {
                                if (pos[tipo].BRM_L || pos[tipo].azienda) {
                                    pos[tipo].quantita = 1;
                                } else {
                                    pos[tipo].quantita = 0;
                                }
                            }
                        }
                    });
                });
                console.log('ğŸ“¦ Normalizzato: qta â†’ quantita per prodotti');
            }
            
            return projectData;
        }
        
        /**
         * Chiudi modal progetti
         */
        function chiudiModalProgetti() {
            const modal = document.getElementById('projects-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        /**
         * Sync manuale
         */
        async function syncManuale() {
            if (!currentProject) {
                alert('âš ï¸ Nessun progetto caricato');
                return;
            }
            
            try {
                console.log('âŸ³ Sync manuale avviata...');
                
                const syncBtn = document.getElementById('sync-btn');
                syncBtn.textContent = 'âŸ³ Sync...';
                syncBtn.classList.add('syncing');
                
                // Ricarica progetto da GitHub
                const projectPath = localStorage.getItem('posa_app_project_path');
                if (!projectPath) {
                    throw new Error('Path progetto non trovato');
                }
                
                const projectData = await loadProjectFromGitHub(projectPath);
                currentProject = projectData;
                localStorage.setItem('posa_app_current_project', JSON.stringify(projectData));
                
                console.log('âœ… Progetto ricaricato da GitHub');
                
                syncBtn.textContent = 'âœ… Aggiornato';
                syncBtn.classList.remove('syncing');
                syncBtn.classList.add('saved');
                
                setTimeout(() => {
                    syncBtn.textContent = 'âŸ³ Sync';
                    syncBtn.classList.remove('saved');
                }, 2000);
                
                // Ri-renderizza vista corrente
                switchView(currentView);
                
            } catch (error) {
                console.error('âŒ Errore sync:', error);
                alert('âŒ Errore sync: ' + error.message);
                
                const syncBtn = document.getElementById('sync-btn');
                syncBtn.textContent = 'âŒ Errore';
                syncBtn.classList.remove('syncing');
                syncBtn.classList.add('error');
                
                setTimeout(() => {
                    syncBtn.textContent = 'âŸ³ Sync';
                    syncBtn.classList.remove('error');
                }, 3000);
            }
        }
        
        /**
         * Vista Per Posizione (placeholder per Step 3)
         */
        function mostraVistaPerPosizione() {
            if (!currentProject || !currentProject.posizioni || currentProject.posizioni.length === 0) {
                const content = document.getElementById('posa-content');
                content.innerHTML = `
                    <div class="empty-state">
                        <h2>ğŸ“ Nessuna Posizione</h2>
                        <p>Il progetto non contiene posizioni</p>
                    </div>
                `;
                return;
            }
            
            console.log('ğŸ“ Rendering Vista Per Posizione...');
            
            const content = document.getElementById('posa-content');
            let html = '';
            
            // Grid di card posizioni
            html += '<div class="posizioni-grid">';
            
            currentProject.posizioni.forEach((pos, index) => {
                html += renderPosizioneCard(pos, index);
            });
            
            html += '</div>';
            
            content.innerHTML = html;
        }
        
        /**
         * Renderizza singola card posizione
         */
        function renderPosizioneCard(pos, index) {
            // Conta prodotti presenti
            const prodotti = [
                { tipo: 'infisso', icon: 'ğŸªŸ', label: 'Infissi', data: pos.infisso },
                { tipo: 'persiana', icon: 'ğŸšª', label: 'Persiane', data: pos.persiana },
                { tipo: 'tapparella', icon: 'ğŸšï¸', label: 'Tapparelle', data: pos.tapparella },
                { tipo: 'zanzariera', icon: 'ğŸ¦Ÿ', label: 'Zanzariere', data: pos.zanzariera },
                { tipo: 'cassonetto', icon: 'ğŸ“¦', label: 'Cassonetti', data: pos.cassonetto }
            ];
            
            const prodottiPresenti = prodotti.filter(p => p.data && p.data.quantita > 0);
            const totaleProdotti = prodottiPresenti.reduce((sum, p) => sum + (p.data.quantita || 0), 0);
            
            // Calcola completamento
            const completamento = calcolaCompletamentoPosizione(pos);
            const coloreCompletamento = completamento === 100 ? '#10b981' : completamento > 50 ? '#f59e0b' : '#ef4444';
            
            // A) Titolo = Ambiente (Camera, Bagno, Sala...)
            const titolo = pos.ambiente || pos.name || pos.stanza || `Posizione ${index + 1}`;
            
            // B) Location senza N/D
            const piano = pos.piano || '';
            const locParts = [piano].filter(x => x && x !== 'N/D');
            const locationStr = locParts.length > 0 ? locParts.join(' - ') : '';
            
            // C) Misure BRM (prova vari formati)
            let misureBRM = '';
            if (pos.infisso) {
                const L = pos.infisso.BRM_L || pos.infisso.brm?.L || 0;
                const H = pos.infisso.BRM_H || pos.infisso.brm?.H || 0;
                if (L > 0 && H > 0) {
                    misureBRM = `ğŸ“ ${L} Ã— ${H} mm`;
                }
            }
            
            let html = `
                <div class="posizione-card" onclick="apriDettaglioPosizione(${index})">
                    <!-- Header Card -->
                    <div class="posizione-header">
                        <div class="posizione-id">${titolo}</div>
                        <div class="posizione-completamento" style="color: ${coloreCompletamento}">
                            ${completamento}%
                        </div>
                    </div>
                    
                    <!-- Info Posizione -->
                    <div class="posizione-info">
                        ${locationStr ? `<div class="posizione-location">ğŸ“ ${locationStr}</div>` : ''}
                        ${pos.id ? `<div class="posizione-codice" style="font-size: 0.75rem; color: #a0aec0;">${pos.id}</div>` : ''}
                    </div>
                    
                    <!-- Misure BRM -->
                    ${misureBRM ? `<div class="posizione-misure" style="font-weight: 600; color: #4f46e5; margin: 0.5rem 0;">${misureBRM}</div>` : ''}
                    
                    <!-- Prodotti -->
                    <div class="prodotti-list">
                        ${prodottiPresenti.length > 0 ? prodottiPresenti.map(p => `
                            <div class="prodotto-item">
                                <span class="prodotto-icon">${p.icon}</span>
                                <span class="prodotto-label">${p.label}</span>
                                <span class="prodotto-qty">Ã—${p.data.quantita}</span>
                            </div>
                        `).join('') : '<div class="prodotto-item-empty">Nessun prodotto</div>'}
                    </div>
                    
                    <!-- Footer -->
                    <div class="posizione-footer">
                        <div class="posizione-total">
                            ${totaleProdotti} prodott${totaleProdotti !== 1 ? 'i' : 'o'}
                        </div>
                        <div class="posizione-action">
                            Vedi dettagli â†’
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        /**
         * Calcola completamento singola posizione
         */
        function calcolaCompletamentoPosizione(pos) {
            let totale = 0;
            let compilati = 0;
            
            const prodotti = ['infisso', 'persiana', 'tapparella', 'zanzariera', 'cassonetto'];
            
            prodotti.forEach(tipo => {
                if (pos[tipo]) {
                    totale += 3; // 3 punti per: quantitÃ , BRM, azienda
                    
                    if (pos[tipo].quantita > 0) compilati++;
                    if (pos[tipo].brm && (pos[tipo].brm.L || pos[tipo].BRM_L)) compilati++;
                    if (pos[tipo].azienda) compilati++;
                }
            });
            
            return totale > 0 ? Math.round((compilati / totale) * 100) : 0;
        }
        
        /**
         * Calcola completamento totale vista POSIZIONI
         * @returns {number} Percentuale 0-100
         */
        function calcolaCompletamentoTotaleVistaPosizioni() {
            if (!currentProject?.posizioni || currentProject.posizioni.length === 0) {
                return 0;
            }
            
            let sommaPercentuali = 0;
            
            currentProject.posizioni.forEach(pos => {
                const percentuale = calcolaCompletamentoPosizione(pos);
                sommaPercentuali += percentuale;
            });
            
            const mediaPercentuale = Math.round(sommaPercentuali / currentProject.posizioni.length);
            
            return mediaPercentuale;
        }
        
        /**
         * Calcola completamento totale vista PRODOTTI
         * @returns {number} Percentuale 0-100
         */
        function calcolaCompletamentoTotaleVistaProdotti() {
            if (!currentProject?.posizioni || currentProject.posizioni.length === 0) {
                return 0;
            }
            
            const tipiProdotto = ['infisso', 'persiana', 'tapparella', 'zanzariera', 'cassonetto'];
            let totaleSlot = 0;
            let slotCompilati = 0;
            
            currentProject.posizioni.forEach(pos => {
                tipiProdotto.forEach(tipo => {
                    totaleSlot++;
                    
                    // Slot compilato se ha quantitÃ  > 0
                    if (pos[tipo]?.quantita > 0) {
                        slotCompilati++;
                    }
                });
            });
            
            return totaleSlot > 0 ? Math.round((slotCompilati / totaleSlot) * 100) : 0;
        }
        
        /**
         * Calcola completamento totale vista AZIENDE
         * @returns {number} Percentuale 0-100
         */
        function calcolaCompletamentoTotaleVistaAziende() {
            if (!currentProject?.posizioni || currentProject.posizioni.length === 0) {
                return 0;
            }
            
            const tipiProdotto = ['infisso', 'persiana', 'tapparella', 'zanzariera', 'cassonetto'];
            let totaleSlot = 0;
            let slotConAzienda = 0;
            
            currentProject.posizioni.forEach(pos => {
                tipiProdotto.forEach(tipo => {
                    // Conta solo se prodotto ha quantitÃ  > 0
                    if (pos[tipo]?.quantita > 0) {
                        totaleSlot++;
                        
                        // Slot compilato se ha azienda assegnata
                        if (pos[tipo].azienda) {
                            slotConAzienda++;
                        }
                    }
                });
            });
            
            return totaleSlot > 0 ? Math.round((slotConAzienda / totaleSlot) * 100) : 0;
        }
        
        /**
         * Restituisce emoji + percentuale formattata
         * @param {number} percentuale - Valore 0-100
         * @returns {string} Es: "ğŸŸ¢ 100%" o "ğŸŸ¡ 65%" o "ğŸ”´ 30%" o "âšª 0%"
         */
        function getIndicatoreFormattato(percentuale) {
            if (percentuale === 0) {
                return 'âšª 0%';
            } else if (percentuale < 50) {
                return `ğŸ”´ ${percentuale}%`;
            } else if (percentuale < 100) {
                return `ğŸŸ¡ ${percentuale}%`;
            } else {
                return `ğŸŸ¢ ${percentuale}%`;
            }
        }
        
        /**
         * Aggiorna tutti gli indicatori nel menu navigazione
         */
        function aggiornaIndicatoriMenu() {
            // Calcola percentuali
            const percPosizioni = calcolaCompletamentoTotaleVistaPosizioni();
            const percProdotti = calcolaCompletamentoTotaleVistaProdotti();
            const percAziende = calcolaCompletamentoTotaleVistaAziende();
            
            // Aggiorna HTML
            const indPosizioni = document.getElementById('indicator-posizione');
            const indProdotti = document.getElementById('indicator-prodotto');
            const indAziende = document.getElementById('indicator-azienda');
            
            if (indPosizioni) {
                indPosizioni.textContent = getIndicatoreFormattato(percPosizioni);
            }
            
            if (indProdotti) {
                indProdotti.textContent = getIndicatoreFormattato(percProdotti);
            }
            
            if (indAziende) {
                indAziende.textContent = getIndicatoreFormattato(percAziende);
            }
            
            console.log('ğŸ“Š Indicatori menu aggiornati:', {
                posizioni: percPosizioni + '%',
                prodotti: percProdotti + '%',
                aziende: percAziende + '%'
            });
        }
        
        /**
         * Apri dettaglio posizione (modal)
         */
        function apriDettaglioPosizione(index) {
            const pos = currentProject.posizioni[index];
            if (!pos) return;
            
            console.log('ğŸ“‹ Apri dettaglio posizione:', pos.id);
            
            // Crea modal
            const modal = document.createElement('div');
            modal.id = 'dettaglio-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 1rem;
                overflow-y: auto;
            `;
            
            const prodotti = [
                { tipo: 'infisso', icon: 'ğŸªŸ', label: 'Infisso', data: pos.infisso },
                { tipo: 'persiana', icon: 'ğŸšª', label: 'Persiana', data: pos.persiana },
                { tipo: 'tapparella', icon: 'ğŸšï¸', label: 'Tapparella', data: pos.tapparella },
                { tipo: 'zanzariera', icon: 'ğŸ¦Ÿ', label: 'Zanzariera', data: pos.zanzariera },
                { tipo: 'cassonetto', icon: 'ğŸ“¦', label: 'Cassonetto', data: pos.cassonetto }
            ];
            
            const prodottiHTML = prodotti.filter(p => p.data && p.data.quantita > 0).map(p => `
                <div style="background: #f7fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div style="font-weight: 600; color: #2d3748;">
                            ${p.icon} ${p.label}
                        </div>
                        <div style="font-weight: 700; color: #f59e0b;">
                            Ã—${p.data.quantita}
                        </div>
                    </div>
                    ${p.data.brm || p.data.BRM_L ? `
                        <div style="font-size: 0.85rem; color: #718096; margin-top: 0.5rem;">
                            ğŸ“ L: ${p.data.brm?.L || p.data.BRM_L || 0}mm Ã— H: ${p.data.brm?.H || p.data.BRM_H || 0}mm
                        </div>
                    ` : ''}
                    ${p.data.azienda ? `
                        <div style="font-size: 0.85rem; color: #718096; margin-top: 0.25rem;">
                            ğŸ¢ ${p.data.azienda}
                        </div>
                    ` : ''}
                    <button onclick="editProdotto(${index}, '${p.tipo}')" 
                            style="margin-top: 0.75rem; padding: 0.5rem 1rem; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        âœï¸ Modifica
                    </button>
                </div>
            `).join('');
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 700px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0; color: #2d3748; font-size: 1.5rem;">
                            ğŸ“‹ ${pos.id || 'Posizione'}
                        </h2>
                        <button onclick="chiudiDettaglioModal()" 
                                style="padding: 0.5rem; background: #e2e8f0; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            âœ•
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f7fafc; border-radius: 8px;">
                        <div style="font-weight: 600; color: #4a5568; margin-bottom: 0.5rem;">
                            ğŸ“ Ubicazione
                        </div>
                        <div style="color: #718096;">
                            ${pos.piano || 'N/D'} | ${pos.stanza || 'N/D'}
                            ${pos.ambiente ? ` | ${pos.ambiente}` : ''}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <h3 style="margin: 0 0 1rem 0; color: #4a5568; font-size: 1.1rem;">
                            ğŸ› ï¸ Prodotti
                        </h3>
                        ${prodottiHTML || '<div style="color: #718096;">Nessun prodotto configurato</div>'}
                    </div>
                    
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button onclick="chiudiDettaglioModal()" 
                                style="padding: 0.75rem 1.5rem; background: #e2e8f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #4a5568;">
                            Chiudi
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        /**
         * Chiudi modal dettaglio
         */
        function chiudiDettaglioModal() {
            const modal = document.getElementById('dettaglio-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        /**
         * Edit prodotto (placeholder Step 7)
         */
        function editProdotto(posizioneIndex, prodottoTipo) {
            chiudiDettaglioModal();
            alert(`ğŸš§ Editing inline in sviluppo - Step 7\nPosizione: ${posizioneIndex}, Prodotto: ${prodottoTipo}`);
        }
        
        /**
         * Vista Per Prodotto (placeholder per Step 4)
         */
        function mostraVistaPerProdotto() {
            if (!currentProject || !currentProject.posizioni || currentProject.posizioni.length === 0) {
                const content = document.getElementById('posa-content');
                content.innerHTML = `
                    <div class="empty-state">
                        <h2>ğŸªŸ Nessun Prodotto</h2>
                        <p>Il progetto non contiene prodotti</p>
                    </div>
                `;
                return;
            }
            
            console.log('ğŸªŸ Rendering Vista Per Prodotto...');
            
            const content = document.getElementById('posa-content');
            let html = '';
            
            // Definizione tipi prodotti
            const tipiProdotti = [
                { tipo: 'infisso', icon: 'ğŸªŸ', label: 'Infissi', color: '#3b82f6' },
                { tipo: 'persiana', icon: 'ğŸšª', label: 'Persiane', color: '#8b5cf6' },
                { tipo: 'tapparella', icon: 'ğŸšï¸', label: 'Tapparelle', color: '#ec4899' },
                { tipo: 'zanzariera', icon: 'ğŸ¦Ÿ', label: 'Zanzariere', color: '#10b981' },
                { tipo: 'cassonetto', icon: 'ğŸ“¦', label: 'Cassonetti', color: '#f59e0b' }
            ];
            
            html += '<div class="prodotti-sections">';
            
            tipiProdotti.forEach(tipoProdotto => {
                const posizioniConProdotto = currentProject.posizioni.filter(pos => 
                    pos[tipoProdotto.tipo] && pos[tipoProdotto.tipo].quantita > 0
                );
                
                if (posizioniConProdotto.length === 0) {
                    // Sezione vuota (opzionale, posso skipparla)
                    return;
                }
                
                const totaleQuantita = posizioniConProdotto.reduce((sum, pos) => 
                    sum + (pos[tipoProdotto.tipo].quantita || 0), 0
                );
                
                html += `
                    <div class="prodotto-section">
                        <div class="prodotto-section-header" style="background: ${tipoProdotto.color}10; border-left: 4px solid ${tipoProdotto.color};">
                            <div class="prodotto-section-title">
                                <span class="prodotto-section-icon">${tipoProdotto.icon}</span>
                                <span class="prodotto-section-label">${tipoProdotto.label}</span>
                            </div>
                            <div class="prodotto-section-count">
                                ${posizioniConProdotto.length} posizion${posizioniConProdotto.length !== 1 ? 'i' : 'e'} Â· 
                                <strong>${totaleQuantita} pezzi</strong>
                            </div>
                        </div>
                        
                        <div class="prodotto-section-content">
                `;
                
                // Lista posizioni con questo prodotto
                posizioniConProdotto.forEach((pos, idx) => {
                    const prodotto = pos[tipoProdotto.tipo];
                    const posIndex = currentProject.posizioni.indexOf(pos);
                    
                    html += `
                        <div class="prodotto-posizione-item" onclick="apriDettaglioPosizione(${posIndex})">
                            <div class="prodotto-posizione-header">
                                <div class="prodotto-posizione-id">${pos.id || `P${String(posIndex + 1).padStart(3, '0')}`}</div>
                                <div class="prodotto-posizione-qty" style="color: ${tipoProdotto.color};">
                                    Ã—${prodotto.quantita}
                                </div>
                            </div>
                            <div class="prodotto-posizione-location">
                                ğŸ“ ${pos.piano || 'N/D'} | ${pos.stanza || 'N/D'}
                            </div>
                            ${prodotto.brm || prodotto.BRM_L ? `
                                <div class="prodotto-posizione-misure">
                                    ğŸ“ L: ${prodotto.brm?.L || prodotto.BRM_L || 0}mm Ã— 
                                    H: ${prodotto.brm?.H || prodotto.BRM_H || 0}mm
                                </div>
                            ` : ''}
                            ${prodotto.azienda ? `
                                <div class="prodotto-posizione-azienda">
                                    ğŸ¢ ${prodotto.azienda}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            content.innerHTML = html;
        }
        
        /**
         * Vista Per Azienda (placeholder per Step 5)
         */
        // Variabile per tracciare azienda selezionata
        let aziendaSelezionata = null;
        
        function mostraVistaPerAzienda() {
            if (!currentProject || !currentProject.posizioni || currentProject.posizioni.length === 0) {
                const content = document.getElementById('posa-content');
                content.innerHTML = `
                    <div class="empty-state">
                        <h2>ğŸ¢ Nessuna Azienda</h2>
                        <p>Il progetto non contiene fornitori configurati</p>
                    </div>
                `;
                return;
            }
            
            console.log('ğŸ¢ Rendering Vista Per Azienda...');
            
            // Raggruppa prodotti per azienda
            const raggruppamentoAziende = raggruppaPerAzienda();
            
            if (Object.keys(raggruppamentoAziende).length === 0) {
                const content = document.getElementById('posa-content');
                content.innerHTML = `
                    <div class="empty-state">
                        <h2>ğŸ¢ Nessun Fornitore</h2>
                        <p>Configura le aziende fornitrici per ogni prodotto</p>
                    </div>
                `;
                return;
            }
            
            const content = document.getElementById('posa-content');
            
            // Se nessuna azienda selezionata, mostra lista aziende
            if (!aziendaSelezionata) {
                mostraListaAziende(raggruppamentoAziende);
            } else {
                mostraDettaglioAzienda(aziendaSelezionata, raggruppamentoAziende[aziendaSelezionata]);
            }
        }
        
        /**
         * Mostra lista aziende come card cliccabili
         */
        function mostraListaAziende(raggruppamentoAziende) {
            const content = document.getElementById('posa-content');
            const aziende = Object.keys(raggruppamentoAziende).sort();
            
            let html = `
                <div style="padding: 1rem;">
                    <h2 style="color: #2d3748; margin-bottom: 1rem; font-size: 1.3rem;">ğŸ¢ Seleziona Fornitore</h2>
                    <div class="posizioni-grid">
            `;
            
            aziende.forEach(azienda => {
                const prodotti = raggruppamentoAziende[azienda];
                const totalePezzi = prodotti.reduce((sum, p) => sum + p.quantita, 0);
                const tipiProdotti = [...new Set(prodotti.map(p => p.tipo))];
                
                // Icona per azienda
                const iconaAzienda = {
                    'finstral': 'ğŸªŸ',
                    'somfy': 'âš¡',
                    'palagina': 'ğŸ¦Ÿ',
                    'punto persiane': 'ğŸšª',
                    'plasticino': 'ğŸšï¸'
                };
                const icona = iconaAzienda[azienda.toLowerCase()] || 'ğŸ¢';
                
                // Colore per azienda
                const coloreAzienda = {
                    'finstral': '#4f46e5',
                    'somfy': '#f59e0b',
                    'palagina': '#10b981',
                    'punto persiane': '#8b5cf6',
                    'plasticino': '#ef4444'
                };
                const colore = coloreAzienda[azienda.toLowerCase()] || '#6366f1';
                
                html += `
                    <div class="posizione-card" onclick="selezionaAzienda('${azienda}')" style="border-left: 4px solid ${colore};">
                        <div class="posizione-header">
                            <div class="posizione-id" style="color: ${colore};">
                                ${icona} ${azienda.toUpperCase()}
                            </div>
                        </div>
                        <div class="posizione-info" style="margin: 1rem 0;">
                            <div style="font-size: 2rem; font-weight: 700; color: ${colore};">${totalePezzi}</div>
                            <div style="color: #718096;">pezzi totali</div>
                        </div>
                        <div class="prodotti-list">
                            ${tipiProdotti.map(tipo => {
                                const iconMap = {'infisso': 'ğŸªŸ', 'persiana': 'ğŸšª', 'tapparella': 'ğŸšï¸', 'zanzariera': 'ğŸ¦Ÿ', 'cassonetto': 'ğŸ“¦'};
                                const labelMap = {'infisso': 'Infissi', 'persiana': 'Persiane', 'tapparella': 'Tapparelle', 'zanzariera': 'Zanzariere', 'cassonetto': 'Cassonetti'};
                                const qtyTipo = prodotti.filter(p => p.tipo === tipo).reduce((s, p) => s + p.quantita, 0);
                                return `<div class="prodotto-item"><span>${iconMap[tipo] || 'ğŸ“¦'}</span> <span>${labelMap[tipo] || tipo}</span> <span class="prodotto-qty">Ã—${qtyTipo}</span></div>`;
                            }).join('')}
                        </div>
                        <div class="posizione-footer">
                            <div></div>
                            <div class="posizione-action">Vedi dettagli â†’</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            content.innerHTML = html;
        }
        
        /**
         * Seleziona un'azienda e mostra dettagli
         */
        function selezionaAzienda(azienda) {
            aziendaSelezionata = azienda;
            mostraVistaPerAzienda();
        }
        
        /**
         * Torna alla lista aziende
         */
        function tornaListaAziende() {
            aziendaSelezionata = null;
            mostraVistaPerAzienda();
        }
        
        /**
         * Mostra dettaglio prodotti di un'azienda
         */
        function mostraDettaglioAzienda(azienda, prodotti) {
            const content = document.getElementById('posa-content');
            const totalePezzi = prodotti.reduce((sum, p) => sum + p.quantita, 0);
            
            // Colore per azienda
            const coloreAzienda = {
                'finstral': '#4f46e5',
                'somfy': '#f59e0b',
                'palagina': '#10b981',
                'punto persiane': '#8b5cf6',
                'plasticino': '#ef4444'
            };
            const colore = coloreAzienda[azienda.toLowerCase()] || '#6366f1';
            
            let html = `
                <div style="padding: 1rem;">
                    <!-- Header con bottone indietro -->
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                        <button onclick="tornaListaAziende()" style="background: #e2e8f0; border: none; padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            â† Indietro
                        </button>
                        <h2 style="color: ${colore}; margin: 0; font-size: 1.5rem;">ğŸ¢ ${azienda.toUpperCase()}</h2>
                        <span style="background: ${colore}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600;">${totalePezzi} pezzi</span>
                    </div>
            `;
            
            // Raggruppa per tipo prodotto
            const prodottiPerTipo = {};
            prodotti.forEach(p => {
                if (!prodottiPerTipo[p.tipo]) prodottiPerTipo[p.tipo] = [];
                prodottiPerTipo[p.tipo].push(p);
            });
            
            // Renderizza ogni tipo
            Object.entries(prodottiPerTipo).forEach(([tipo, items]) => {
                const iconMap = {'infisso': 'ğŸªŸ', 'persiana': 'ğŸšª', 'tapparella': 'ğŸšï¸', 'zanzariera': 'ğŸ¦Ÿ', 'cassonetto': 'ğŸ“¦'};
                const labelMap = {'infisso': 'Infissi', 'persiana': 'Persiane', 'tapparella': 'Tapparelle', 'zanzariera': 'Zanzariere', 'cassonetto': 'Cassonetti'};
                const totaleQty = items.reduce((s, i) => s + i.quantita, 0);
                
                html += `
                    <div style="background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.75rem; border-bottom: 2px solid #f0f0f0; margin-bottom: 0.75rem;">
                            <span style="font-weight: 700; font-size: 1.1rem;">${iconMap[tipo] || 'ğŸ“¦'} ${labelMap[tipo] || tipo}</span>
                            <span style="background: ${colore}; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-weight: 600;">Ã—${totaleQty}</span>
                        </div>
                `;
                
                items.forEach(item => {
                    // Estrai ambiente dalla posizione
                    const pos = currentProject.posizioni[item.posizioneIndex];
                    const ambiente = pos?.ambiente || pos?.name || item.posizioneId;
                    
                    html += `
                        <div onclick="apriDettaglioPosizione(${item.posizioneIndex})" style="display: flex; align-items: center; padding: 0.75rem; background: #f8fafc; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f8fafc'">
                            <div style="font-weight: 700; color: ${colore}; min-width: 100px;">${ambiente}</div>
                            <div style="flex: 1;">
                                ${item.misure ? `<div style="font-size: 0.9rem; color: #4a5568;">ğŸ“ ${item.misure}</div>` : ''}
                                <div style="font-size: 0.8rem; color: #a0aec0;">${item.posizioneId}</div>
                            </div>
                            <div style="font-weight: 700; color: ${colore};">Ã—${item.quantita}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            content.innerHTML = html;
        }
        
        /**
         * Raggruppa prodotti per azienda
         */
        function raggruppaPerAzienda() {
            const raggruppamento = {};
            
            const tipiProdotti = ['infisso', 'persiana', 'tapparella', 'zanzariera', 'cassonetto'];
            
            currentProject.posizioni.forEach((pos, posIndex) => {
                tipiProdotti.forEach(tipo => {
                    const prodotto = pos[tipo];
                    
                    if (prodotto && prodotto.quantita > 0 && prodotto.azienda) {
                        const azienda = prodotto.azienda;
                        
                        if (!raggruppamento[azienda]) {
                            raggruppamento[azienda] = [];
                        }
                        
                        const misure = prodotto.brm || prodotto.BRM_L ? 
                            `L: ${prodotto.brm?.L || prodotto.BRM_L || 0}mm Ã— H: ${prodotto.brm?.H || prodotto.BRM_H || 0}mm` : 
                            null;
                        
                        // Ambiente senza N/D
                        const ambiente = pos.ambiente || pos.name || pos.stanza || '';
                        const piano = pos.piano || '';
                        const locationParts = [piano, ambiente].filter(x => x && x !== 'N/D');
                        
                        raggruppamento[azienda].push({
                            tipo: tipo,
                            quantita: prodotto.quantita,
                            posizioneId: pos.id || `P${String(posIndex + 1).padStart(3, '0')}`,
                            posizioneIndex: posIndex,
                            posizioneLocation: locationParts.join(' - ') || 'N/D',
                            ambiente: ambiente,
                            misure: misure
                        });
                    }
                });
            });
            
            return raggruppamento;
        }
        
        /**
         * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         * BANNER CLIENTE E RIEPILOGO QUANTITÃ€
         * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         */
        
        /**
         * Aggiorna banner con info cliente
         */
        function aggiornaBannerCliente() {
            const banner = document.getElementById('cliente-banner');
            if (!currentProject) {
                banner.style.display = 'none';
                return;
            }
            
            banner.style.display = 'block';
            
            // Nome cliente
            const nome = currentProject.name || currentProject.client || currentProject.customerName || 'Cliente';
            document.getElementById('cliente-nome-display').textContent = nome;
            
            // Indirizzo
            let indirizzo = '';
            if (currentProject.clientData) {
                const cd = currentProject.clientData;
                const parts = [cd.indirizzo, cd.citta, cd.cap].filter(x => x);
                indirizzo = parts.join(', ');
            }
            if (!indirizzo) {
                indirizzo = currentProject.indirizzo || currentProject.address || '-';
            }
            document.getElementById('cliente-indirizzo').textContent = indirizzo;
            
            // Telefono
            let telefono = '';
            if (currentProject.clientData && currentProject.clientData.telefono) {
                telefono = currentProject.clientData.telefono;
            } else {
                telefono = currentProject.telefono || currentProject.phone || '-';
            }
            document.getElementById('cliente-telefono').textContent = telefono;
        }
        
        /**
         * Aggiorna riepilogo quantitÃ  prodotti
         */
        function aggiornaRiepilogoQty() {
            const container = document.getElementById('riepilogo-qty');
            if (!currentProject || !currentProject.posizioni) {
                container.innerHTML = '';
                return;
            }
            
            // Conta prodotti per tipo
            const conteggi = {
                infisso: { icon: 'ğŸªŸ', label: 'Infissi', qty: 0 },
                persiana: { icon: 'ğŸšª', label: 'Persiane', qty: 0 },
                tapparella: { icon: 'ğŸšï¸', label: 'Tapparelle', qty: 0 },
                zanzariera: { icon: 'ğŸ¦Ÿ', label: 'Zanzariere', qty: 0 },
                cassonetto: { icon: 'ğŸ“¦', label: 'Cassonetti', qty: 0 }
            };
            
            currentProject.posizioni.forEach(pos => {
                Object.keys(conteggi).forEach(tipo => {
                    if (pos[tipo] && pos[tipo].quantita > 0) {
                        conteggi[tipo].qty += pos[tipo].quantita;
                    }
                });
            });
            
            // Genera HTML solo per prodotti presenti
            let html = '';
            Object.values(conteggi).forEach(item => {
                if (item.qty > 0) {
                    html += `
                        <div class="qty-badge">
                            <span>${item.icon}</span>
                            <span class="qty-num">${item.qty}</span>
                        </div>
                    `;
                }
            });
            
            // Totale posizioni
            html += `
                <div class="qty-badge" style="background: rgba(255,255,255,0.3);">
                    <span>ğŸ“</span>
                    <span class="qty-num">${currentProject.posizioni.length}</span>
                    <span>pos</span>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        /**
         * Copia testo negli appunti
         */
        function copiaClipboard(elementId) {
            const elemento = document.getElementById(elementId);
            const testo = elemento.textContent;
            
            if (!testo || testo === '-') {
                mostraToast('âš ï¸ Nessun dato da copiare');
                return;
            }
            
            navigator.clipboard.writeText(testo).then(() => {
                mostraToast('âœ… Copiato: ' + testo);
            }).catch(err => {
                // Fallback per browser vecchi
                const textarea = document.createElement('textarea');
                textarea.value = testo;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                mostraToast('âœ… Copiato: ' + testo);
            });
        }
        
        /**
         * Mostra toast notifica
         */
        function mostraToast(messaggio) {
            // Rimuovi toast esistente
            const esistente = document.querySelector('.toast-copia');
            if (esistente) esistente.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast-copia';
            toast.textContent = messaggio;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 2000);
        }
        
        // Log finale
        console.log('ğŸ¯ Posa App v1.66 caricata');
    </script>
</body>
</html>
